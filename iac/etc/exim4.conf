# vi: set ts=8 sw=4 :

######################################################################
#                    MAIN CONFIGURATION SETTINGS                     #
######################################################################

timezone = UTC
add_environment = <; PATH=/bin:/usr/bin
keep_environment =
# log_selector = +smtp_confirmation +protocol_detail +queue_time_overall +millisec
log_selector = +all

disable_ipv6 = no
daemon_smtp_ports = 25
# local_interfaces = 127.0.0.1
host_lookup = *
rfc1413_hosts = *
rfc1413_query_timeout = 0s

bounce_return_body = false
ignore_bounce_errors_after = 0d
timeout_frozen_after = 7d
message_size_limit = 50M
never_users = root

primary_hostname = mail.teefs.eu
domainlist local_domains = @ : localhost
domainlist routable_domains = dsearch;/etc/exim4/my/domains

gecos_pattern = ([^,]*)
gecos_name = $1

# acl_smtp_rcpt = acl_check_rcpt
# acl_smtp_notquit = acl_smtp_notquit

acl_not_smtp = acl_not_smtp
# acl_not_smtp_mime = acl_not_smtp_mime # requires content-scanning support
acl_not_smtp_start = acl_not_smtp_start
# acl_smtp_atrn = acl_smtp_atrn # requires 4.99
acl_smtp_auth = acl_smtp_auth
acl_smtp_connect = acl_smtp_connect
acl_smtp_data = acl_smtp_data
acl_smtp_data_prdr = acl_smtp_data_prdr
acl_smtp_dkim = acl_smtp_dkim
acl_smtp_etrn = acl_smtp_etrn
acl_smtp_expn = acl_smtp_expn
acl_smtp_helo = acl_smtp_helo
acl_smtp_mail = acl_smtp_mail
acl_smtp_mailauth = acl_smtp_mailauth
# acl_smtp_mime = acl_smtp_mime # requires content-scanning support
acl_smtp_notquit = acl_smtp_notquit
acl_smtp_predata = acl_smtp_predata
acl_smtp_quit = acl_smtp_quit
acl_smtp_rcpt = acl_smtp_rcpt
acl_smtp_starttls = acl_smtp_starttls
acl_smtp_vrfy = acl_smtp_vrfy
# acl_smtp_wellknown = acl_smtp_wellknown # requires 4.98

######################################################################
#                       ACL CONFIGURATION                            #
######################################################################

begin acl

acl_not_smtp:
    accept logwrite = ACL_NOT_SMTP
acl_not_smtp_mime:
    accept logwrite = ACL_NOT_SMTP_MIME
acl_not_smtp_start:
    require logwrite = ACL_NOT_SMTP_START

acl_smtp_atrn:
    deny logwrite = ACL_NOT_SMTP_ATRN
acl_smtp_etrn:
    deny logwrite = ACL_NOT_SMTP_ETRN
acl_smtp_expn:
    deny logwrite = ACL_NOT_SMTP_EXPN
acl_smtp_vrfy:
    deny logwrite = ACL_SMTP_VRFY
acl_smtp_wellknown:
    deny logwrite = ACL_SMTP_WELLKNOWN

acl_smtp_auth:
    accept logwrite = ACL_SMTP_AUTH [$sender_host_address]:$sender_host_port
acl_smtp_connect:
    accept logwrite = ACL_SMTP_CONNECT [$sender_host_address]:$sender_host_port
acl_smtp_data:
    accept logwrite = ACL_SMTP_DATA [$sender_host_address]:$sender_host_port
acl_smtp_data_prdr:
    accept logwrite = ACL_SMTP_DATA_PRDR
acl_smtp_dkim:
    accept logwrite = ACL_SMTP_DKIM
acl_smtp_helo:
    accept logwrite = ACL_SMTP_HELO [$sender_host_address]:$sender_host_port "$sender_helo_name"
acl_smtp_mail:
    accept logwrite = ACL_SMTP_MAIL [$sender_host_address]:$sender_host_port "$sender_address"
acl_smtp_mailauth:
    accept logwrite = ACL_SMTP_MAILAUTH
acl_smtp_mime:
    accept logwrite = ACL_SMTP_MIME


acl_smtp_notquit:
    accept logwrite = ACL_SMTP_NOTQUIT [$sender_host_address]:$sender_host_port "$smtp_notquit_reason"

acl_smtp_predata:
    accept logwrite = ACL_SMTP_PREDATA
acl_smtp_quit:
    require logwrite = ACL_SMTP_QUIT [$sender_host_address]:$sender_host_port
# acl_smtp_rcpt
acl_smtp_starttls:
    accept logwrite = ACL_SMTP_STARTTLS [$sender_host_address]:$sender_host_port

acl_check_hostname:

    accept
        hosts = :

    accept
        authenticated = *

    deny
        condition = ${lookup dnsdb{ptr=$sender_host_address} {no}{yes}}
        message = No mail accepted from hosts with no reverse DNS

    deny
        condition = ${if eq {$host_lookup_failed}{1}}
        message = No mail accepted from hosts with bad reverse DNS

    deny
        condition = ${if eq {$sender_host_name}{}}
        message = No mail accepted from unnamed hosts

    accept

acl_smtp_rcpt:

    deny    !acl = acl_check_hostname

    # Sender and recipient must both be valid
    require verify = sender
    require verify = recipient

    # No sender spoofing
    deny    sender_domains = +local_domains : +routable_domains
            !authenticated = *

    # No relaying
    deny    !domains = +routable_domains
            !authenticated = *

    accept

######################################################################
#                      ROUTERS CONFIGURATION                         #
######################################################################

begin routers

local_aliases:
    driver = redirect
    domains = +local_domains
    data = ${lookup{$local_part}lsearch{/etc/aliases}}

our_domains_aliases:
    driver = redirect
    domains = +routable_domains
    data = ${lookup{$local_part}wildlsearch{/etc/exim4/my/domains/$domain_data/aliases}}
    allow_fail

maildir_archive:
    domains = maildir.localdomain
    driver = accept
    transport = archive
    no_verify
    unseen

maildir_main:
    domains = maildir.localdomain
    driver = accept
    transport = maildir

# Validate and deliver using DNS
dns_lookup:
    driver = dnslookup
    domains = !+local_domains
    transport = remote_smtp
    ignore_target_hosts = <, \
        0.0.0.0/8, \
        127.0.0.0/8, \
        255.0.0.0/8, \
        10.0.0.0/8, \
        172.16.0.0/12, \
        192.168.0.0/16, \
        0::/29, \
        f::/29
    no_qualify_single
    no_more

# Local users can be mapped to remote ones via /etc/aliases
system_aliases:
    driver = redirect
    domains = +local_domains
    data = ${lookup{$local_part}lsearch{/etc/aliases}}

######################################################################
#                      TRANSPORTS CONFIGURATION                      #
######################################################################

begin transports

remote_smtp:
    driver = smtp

archive:
    driver = appendfile
    maildir_format = true
    directory = /home/archivist/mail
    user = archivist

maildir:
    driver = appendfile
    maildir_format = true
    directory = /home/rachel/mail/${local_part}
    user = rachel

######################################################################
#                      RETRY CONFIGURATION                           #
######################################################################

begin retry

# This single retry rule applies to all domains and all errors. It specifies
# retries every 15 minutes for 2 hours, then increasing retry intervals,
# starting at 1 hour and increasing each time by a factor of 1.5, up to 16
# hours, then retries every 6 hours until 4 days have passed since the first
# failed delivery.

# Address or Domain    Error       Retries
# -----------------    -----       -------

*                      *           F,2h,15m; G,16h,1h,1.5; F,4d,6h

######################################################################
#                      REWRITE CONFIGURATION                         #
######################################################################

# begin rewrite

# # Use a routable (and deliverable) Mailer-Daemon address
# Mailer-Daemon@+local_domains rachel@rachelevans.org

# # For other local addresses, use the address listed in email-addresses
# # (or a default) as the envelope sender
# *@+local_domains "${lookup{${local_part}}lsearch{/etc/email-addresses} {$value}{rachel@rachelevans.org}}" F

######################################################################
#                   AUTHENTICATION CONFIGURATION                     #
######################################################################

begin authenticators

fixed_plain:
    server_advertise_condition = ${if eq{$tls_in_cipher}{}{no}{yes}}
    driver = plaintext
    public_name = PLAIN
    server_prompts = :
    server_condition = ${lookup{$auth2}lsearch{/etc/exim4/my/users}{${if crypteq{$auth3}{$value}}} {false}}
    server_set_id = $auth2

# End of Exim configuration file
